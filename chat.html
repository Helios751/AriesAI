<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARIES Chat UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body class="h-screen flex flex-col bg-gradient-to-b from-blue-900 to-purple-900">

  <!-- Chat Container -->
  <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-3 mb-20">
    <!-- Pesan awal bot -->
    <div class="flex items-start space-x-2">
      <img src="./images/logo_ARIES.png" class="w-8 h-8" alt="logo">
      <div class="bg-purple-700 text-white px-3 py-2 rounded-lg max-w-xs border border-white">
        Apa yang saya bisa bantu terkait dengan mata pelajaran <span id="category-chat"></span>?
      </div>
    </div>
  </div>

  <!-- Input Bar (Fixed di bawah) -->
  <div
    class="p-3 border-t border-white flex items-center space-x-2 bg-gradient-to-r from-indigo-800 to-purple-700 fixed bottom-0 w-full">
    <!-- Tombol kiri -->
    <button class="w-10 h-10 flex items-center justify-center border-2 border-white rounded" id="btn-send-massage">
      ⬆
    </button>

    <!-- Input Chat -->
    <input id="chatInput" type="text" placeholder="Tulis pesan..."
      class="flex-1 bg-gradient-to-r from-blue-900 to-purple-900 text-white px-3 py-2 border-2 border-white rounded focus:outline-none">

    <!-- Tombol kanan (mic) -->
    <button class="w-10 h-10 flex items-center justify-center border-2 border-white rounded-full" id="btn-mic">
      
    </button>
  </div>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const chatInput = document.getElementById("chatInput");
    var query = new URLSearchParams(window.location.search)
    var categoryName = query.get("category")
    const micButton = document.getElementById("btn-mic");

    // Event enter kirim pesan
    chatInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && chatInput.value.trim() !== "") {
        const userMsg = chatInput.value;
        addUserMessage(userMsg);
        chatInput.value = "";

        // Bot auto reply
        setTimeout(() => {
          botReply(userMsg);
        }, 600);
      }
    });

    // Tambahkan pesan user (kanan)
    function addUserMessage(text) {
      const msg = document.createElement("div");
      msg.className = "flex justify-end";
      msg.innerHTML = `
        <div class="bg-indigo-600 text-white px-3 py-2 rounded-lg max-w-xs text-left border border-white">
          ${text}
        </div>
      `;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Tambahkan pesan bot (kiri)
    function addBotMessage(text) {
      const msg = document.createElement("div");
      msg.className = "flex items-start space-x-2";
      msg.innerHTML = `
        <img src="./images/logo_ARIES.png" class="w-8 h-8" alt="logo">
        <div class="bg-purple-700 text-white px-3 py-2 rounded-lg max-w-xs border border-white">
          ${text}
        </div>
      `;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Tambahkan bubble typing
    function addTypingBubble() {
      const msg = document.createElement("div");
      msg.className = "flex items-start space-x-2 typing-bubble";
      msg.innerHTML = `
        <img src="./images/logo_ARIES.png" class="w-8 h-8" alt="logo">
        <div class="bg-purple-700 text-white px-3 py-2 rounded-lg max-w-xs border border-white animate-pulse">
          ...
        </div>
      `;
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Hapus typing bubble
    function removeTypingBubble() {
      const typing = document.querySelector(".typing-bubble");
      if (typing) typing.remove();
    }

    // Logic auto-reply bot
    async function botReply(userMsg) {
      const msgLower = userMsg.toLowerCase();

      // Tambahkan typing bubble sebelum fetch
      addTypingBubble();

      try {
        const res = await fetch("https://studious-invention-9vq4rxgrjqgfp46q-5000.app.github.dev/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ question: msgLower, category: categoryName })
        });

        const data = await res.json();

        // Hapus typing bubble, ganti dengan jawaban bot
        removeTypingBubble();
        addBotMessage(data.answer || "Bot belum menyiapkan jawaban.");
      } catch (err) {
        removeTypingBubble();
        addBotMessage("⚠️ Error koneksi ke server.");
      }
    }

    var categorychat = document.getElementById("category-chat")
    categorychat.innerHTML = categoryName

    document.getElementById("btn-send-massage").addEventListener("click", function () {
      const userMsg = chatInput.value;
      addUserMessage(userMsg);
      chatInput.value = "";

      // Bot auto reply
      setTimeout(() => {
        botReply(userMsg);
      }, 600);
    })

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.lang = "id-ID";
    recognition.continuous = false;
    recognition.interimResults = false;

    // Event ketika mulai merekam
    recognition.onstart = () => {
      micButton.textContent = "🔴"; // ganti icon jadi merah
      micButton.classList.add("animate-pulse", "bg-red-600");
    };

    // Event ketika selesai merekam
    recognition.onend = () => {
      micButton.textContent = "🎤"; // kembali ke mic
      micButton.classList.remove("animate-pulse", "bg-red-600");
    };

    // Event hasil rekaman
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      chatInput.value = transcript; // isi langsung ke input chat
    };

    // Event error
    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
      micButton.textContent = "🎤";
      micButton.classList.remove("animate-pulse", "bg-red-600");
    };

    // Klik tombol mic untuk mulai rekam
    micButton.addEventListener("click", () => {
      recognition.start();
    });
  </script>
</body>

</html>